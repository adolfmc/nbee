<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!--微信浏览器缓存清理-->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Metro 4 -->
    <link rel="stylesheet" href="./v4/css/metro-all.min.css">
    <link rel="stylesheet" href="./v4/css/metro.min.css">
    <link rel="stylesheet" href="./v4/css/metro-colors.min.css">
    <link rel="stylesheet" href="./v4/css/metro-rtl.min.css">
    <link rel="stylesheet" href="./v4/css/metro-icons.min.css">
    <script src="./v4/js/metro.min.js"></script>
    <link href="./assistant/css/base.css" type="text/css" rel="stylesheet">
    <link href="./assistant/css/style.css" rel="stylesheet">
    <link href="./assistant/css/swiper.min.css" rel="stylesheet">
    <link href="./assistant/css/swiper.css" rel="stylesheet">
    <link href="./assistant/css/font-awesome.css" type="text/css" rel="stylesheet">
    <link href="./assistant/css/home_list.css" type="text/css" rel="stylesheet">

    <script src="./assistant/js/jquery.js"></script>
    <script src="./assistant/js/jquery.excoloSlider.js"></script>
    <link href="./assistant/css/jquery.excoloSlider.css" rel="stylesheet">

    <script src="./assistant/js/swiper.min.js"></script>
    <script src="./assistant/js/swiper.js"></script>
    <script src="./assistant/js/layer/layer.js"></script>
    <script src="./assistant/js/tools.js?v=Math.random()"></script>
    <script src="./assistant/js/home.js?v=Math.random()"></script>
    <script src="./assistant/js/venueOpera.js?v=Math.random()"></script>
    <!-- <script src="./assistant/js/jweixin-1.6.0.js"></script> -->
    <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <style>
    </style>
</head>

<body>
    <div style="height: 100%;">
        <!-- 左侧面菜单 -->
        <aside class="sidebar pos-absolute z-2" data-role="sidebar" data-toggle="#sidebar-toggle-4" id="sb4" data-shift=".shifted-content-2" data-static-shift=".shifted-content-2" data-static="md">
            <div class="sidebar-header" data-image="./v4/images/sb-bg-1.jpg">
                <div class="avatar">
                    <img data-role="gravatar" data-email="sergey@pimenov.com.ua" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKYPpOWCGE1Mib6CcLpt7qaKBdbooPcicBxSTbNric5O9Nibticx8XibgwkrXlwtPGv7icwSf2GH95sG5KibA/132" />
                </div>
                <span class="title fg-white" id='left_list_id'> Automatic appointment 
                    <div style="font-size: 1rem;margin-top: 1.3rem;font-weight: 600;">(自动预约SAAS平台）</div>
                </span>
                <span class="subtitle fg-white"> 2019 © Yushang Sci. & Tech by mc</span>
            </div>
            <ul class="sidebar-menu">
                <li><a href="./home.html"><span class="mif-home icon"></span><div style="margin-top: .4rem;">主页</div></a></li>
                <li><a onclick="ck_product()"><span class="mif-books icon"></span>预约</a></li>
                <li><a href="./order_list.html"><span class="mif-files-empty icon"></span>历史</a></li>
                <li class="divider"></li>
                <li><a href="./user.html"><span class="mif-images icon"></span>我的</a></li>
            </ul>
        </aside>        

        <!--  内容 START MAIN 面板  -->
        <div class="shifted-content-2 h-100 p-ab" style="background: #f9f9f6;">
            <!-- 标题 -->
            <div class="appbar pos-absolute bg-red z-1" data-role="appbar">
                <div>
                    <button class="app-bar-item c-pointer" id="sidebar-toggle-4">
                        <span class="mif-menu fg-white"></span>
                        <!-- <span id="span_pid" style="width:350px;font-size:1.3rem;color: white;">首页</span> -->
                    </button>
                </div>
                
                <div class="search">
                    <input type="text" placeholder="请输入场馆名、地址、区域" name="" id="" value="" />
                    <button ><i>搜索</i></button>
                </div>

            </div>

            <!-- 场馆列表-->
            <div  class="web2-list" style="display:''" >
                <div class="web2-list-title"><span>推荐场馆</span> </div>
                <ul id="venus_list_indexid">
                    <li data-href="/court/detail?id=19057&amp;cid=11">
                        <div class="preload"
                            data-url="https://img3.qydimg.com/uploads/20170119/2016081472098689889410477107.jpg-old8QCqQ"
                            style="background-image: url(&quot;https://img3.qydimg.com/uploads/20170119/2016081472098689889410477107.jpg-old8QCqQ&quot;);">
                        </div>
                        <div>
                            <p> <span>TiGoal室内足球场</span></p>
                            <p>[外高桥]</p>
                            <p> <span>￥<em>300</em></span>
                                <span>￥450</span>
                                <i data-href="/court/book?bid=19057&amp;cid=11&amp;t=1602000000">预订</i>
                
                            </p>
                        </div>
                    </li>
                    <li data-href="/court/detail?id=6581&amp;cid=1">
                        <div class="preload"
                            data-url="https://img3.qydimg.com/uploads/20170118/2016031458122219190415892663.jpg-old8QCqQ"
                            style="background-image: url(&quot;https://img3.qydimg.com/uploads/20170118/2016031458122219190415892663.jpg-old8QCqQ&quot;);">
                        </div>
                        <div>
                            <p> <span>光大欣吉羽毛球馆</span></p>
                            <p>[漕河泾/田林]</p>
                            <p> <span>￥<em>30</em></span>
                                <span>￥50</span>
                                <i data-href="/court/book?bid=6581&amp;cid=1&amp;t=1602000000">预订</i>
                
                            </p>
                        </div>
                    </li>

                </ul>
            </div>
            <!--  内容 END  -->
        </div>
    </div>


    <!-- Metro 4 -->
    <script>
        $(function () {
            //2 进入页面要求 获取微信用户信息
            invate_wechat_user();

            //5 H5获取定位 & 6 加载场馆信息
            var ua = navigator.userAgent.toLowerCase();
            var isWeixin = ua.indexOf('micromessenger') != -1;
            if (isWeixin) {
                getLocation();
            }else{
                var lng1 = 121.515244;// 经度;
                var lat1 = 31.181736;// 维度;
                //6 加载场馆信息
                getVenues(lng1,lat1);
            }
            
        });

        function getLocation(){ 
            $.ajax({type : "POST", url : base_url+"/wxpay/getSignature",
                data:{url:location.href.split('#')[0]}
                ,success : function(result) {
                    data = result.data;
                    // 通过config接口注入权限验证配置
                    wx.config({
                        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        appId: 'wx98188fbf500bdf33', // 必填，公众号的唯一标识
                        timestamp: data.timestamp, // 必填，生成签名的时间戳
                        nonceStr: data.nonceStr, // 必填，生成签名的随机串
                        signature: data.signature,// 必填，签名
                        jsApiList: ['getLocation'] // 必填，需要使用的JS接口列表    (1)获取地理位置接口
                    });

                    
                    // 步骤四：通过ready接口处理成功验证
                    wx.ready(function(){
                    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
                            // 获取地理位置接口
                            wx.getLocation({
                                type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                                success: function (res) {
                                    var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                                    var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                                    var speed = res.speed; // 速度，以米/每秒计
                                    var accuracy = res.accuracy; // 位置精度
                                    getVenues(longitude,latitude);
                                }
                            });
                    });

                    // 步骤五：通过error接口处理失败验证
                    wx.error(function(res){
                    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
                        console.log(res);
                    });

                }
            });
        }


        function invate_wechat_user(){
            // 本地开发 设置默认值
            storage.headimgurl='https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKYPpOWCGE1Mib6CcLpt7qaKBdbooPcicBxSTbNric5O9Nibticx8XibgwkrXlwtPGv7icwSf2GH95sG5KibA/132';
            storage.openId='o21Tg5gcRWoqpNLzPmRZWU2buwvM';
            var cook_headimgurl = storage['headimgurl'];

            if(cook_headimgurl==null ||cook_headimgurl=='' || cook_headimgurl =="undefined"){
                var redirect_getUser_URL = base_url + '/wxpay/getWechatUser.do'
                var wxUrl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx98188fbf500bdf33&redirect_uri=" + encodeURIComponent(redirect_getUser_URL) + "&response_type=code&scope=snsapi_userinfo#wechat_redirect";
                // alert("微信："+wxUrl);
                window.location.href = wxUrl;

                var headimgurl=getUrlParam('headimgurl');
                var openid=getUrlParam('openid');
                var nickname=getUrlParam('nickname');
                storage.headimgurl=headimgurl;
                storage.openid=openid;
                storage.nickname=nickname;
                cook_headimgurl = headimgurl;
            }
            
            //设置头像
            $('.avatar >img')[0].src = cook_headimgurl
        }



        function return_venue(siteId,productId,isHalf,venueName,address,tel,img,venueId,sportType){
            window.location.href="./venue.html?venueId="+venueId+"&siteId="+siteId+"&productId="+productId+"&isHalf="+isHalf+"&sportType="+sportType ;
        }

        function distance_show(data){
            if( Math.round(data.distance/1000) >0){
                return Math.round(data.distance/1000)+'公里';
            }else{
                return Math.round(data.distance)+'米';
            }
        }

        function getVenues(lng1,lat1){
            $.ajax({
                type : "POST"
                ,url:base_url+"/getVenues"
                ,data:{"lng1":lng1,"lat1":lat1}
                ,success:function(result) {
                    console.log(result)
                    var div_str = '';
                    result = result.data;
                    if(result!=null ){
                        for(var i=0;i<result.length;i++){
                            data = result[i];
                            
                            div_str = div_str + '<div class="myOrder-venue-infor">';
                            div_str = div_str + '<li><a href=javascript:return_venue("'+data.siteId+'","'+data.productId+'","'+data.isHalf+'","'+encodeURIComponent(data.venueName)+'","'+encodeURIComponent(data.addres)+'","'+encodeURIComponent(data.tel)+'","'+encodeURIComponent(data.img)+'","'+data.id+'","'+data.sportType+'"); style="text-decoration:none;">';
                            div_str = div_str + '    <div class="preload"';
                            div_str = div_str + '        data-url="'+data.img+'"';
                            div_str = div_str + '        style="background-image: url(&quot;'+data.img+'&quot;);">';
                            div_str = div_str + '    </div>';
                            div_str = div_str + '    <div>';
                            div_str = div_str + '        <p> <span>'+data.venueName+'</span></p>';
                            div_str = div_str + '        <p>['+data.area+']  '+distance_show(data)+'</p>';
                            div_str = div_str + '        <p> <span>￥<em>'+data.salesPrice+'</em></span>';
                            div_str = div_str + '            <span>￥'+data.price+'</span>';
                            div_str = div_str + '            <i>预订</i>';
                            div_str = div_str + '        </p>';
                            div_str = div_str + '    </div>';
                            div_str = div_str + '</a></li>';
                        }
                    }
                    $('#venus_list_indexid').empty();
                    $('#venus_list_indexid').append(div_str);
                    
                }
            });

            //保存经纬度
            $.ajax({
                type : "POST"
                ,url:base_url+"/saveLocus"
                ,data:{"lng":lng1,"lat":lat1,'openId':storage['openId']}
                ,success:function(result) {
                }
            });
        }
    </script>
</body>

</html>
